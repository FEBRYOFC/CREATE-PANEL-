version: "3.9"

# ================================
#  PTERODACTYL PANEL - PRODUCTION
# ================================
# Services included:
# - panel        (Laravel PHP application)
# - nginx        (reverse proxy + static file server)
# - mariadb      (database)
# - redis        (cache + queue backend)
# - queue-worker (Laravel queue worker)
# - scheduler    (Laravel scheduler)
#
# All persistent data stored in volumes.

services:

  # -------------------------------
  # DATABASE (MariaDB 10.5+)
  # -------------------------------
  mariadb:
    image: mariadb:10.5
    command: --max-connections=500 --innodb-buffer-pool-size=1G
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: pterodactyl
      MYSQL_USER: pterodactyl
      MYSQL_PASSWORD: panelpass
      MYSQL_ROOT_PASSWORD: rootpass
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - ptero

  # -------------------------------
  # REDIS
  # -------------------------------
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    networks:
      - ptero

  # -------------------------------
  # PTERODACTYL PANEL (PHP-FPM)
  # -------------------------------
  panel:
    image: ghcr.io/pterodactyl/panel:1.12.1
    restart: unless-stopped
    depends_on:
      - mariadb
      - redis
    env_file:
      - ./panel.env
    volumes:
      - panel_app:/app
      - panel_logs:/app/storage/logs
    networks:
      - ptero

  # -------------------------------
  # QUEUE WORKER
  # -------------------------------
  queue-worker:
    image: ghcr.io/pterodactyl/panel:1.12.1
    restart: unless-stopped
    depends_on:
      - panel
      - redis
      - mariadb
    env_file:
      - ./panel.env
    entrypoint: ["php", "/app/artisan", "queue:work", "--queue=high,standard,low", "--sleep=3", "--tries=3"]
    volumes:
      - panel_app:/app
    networks:
      - ptero

  # -------------------------------
  # SCHEDULER (cron runner)
  # -------------------------------
  scheduler:
    image: ghcr.io/pterodactyl/panel:1.12.1
    restart: unless-stopped
    depends_on:
      - panel
    env_file:
      - ./panel.env
    entrypoint: ["sh", "-c", "while true; do php /app/artisan schedule:run --verbose --no-interaction; sleep 60; done"]
    volumes:
      - panel_app:/app
    networks:
      - ptero

  # -------------------------------
  # NGINX
  # -------------------------------
  nginx:
    image: nginx:stable
    restart: unless-stopped
    depends_on:
      - panel
    volumes:
      - panel_app:/var/www/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"
      - "443:443"
    networks:
      - ptero


# -------------------------------
# NETWORKS
# -------------------------------
networks:
  ptero:

# -------------------------------
# VOLUMES (PERSISTENCE)
# -------------------------------
volumes:
  panel_app:
  panel_logs:
  mariadb_data:
  redis_data:
